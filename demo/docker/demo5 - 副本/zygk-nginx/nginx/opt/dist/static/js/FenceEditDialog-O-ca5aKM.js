var e=Object.defineProperty,a=Object.defineProperties,l=Object.getOwnPropertyDescriptors,t=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,s=(a,l,t)=>l in a?e(a,l,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[l]=t,o=(e,a,l)=>new Promise(((t,n)=>{var r=e=>{try{o(l.next(e))}catch(a){n(a)}},s=e=>{try{o(l.throw(e))}catch(a){n(a)}},o=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,s);o((l=l.apply(e,a)).next())}));import{d as u,Y as i,Z as c,n as d,A as m,a0 as f,a7 as p,a8 as v,aM as g,ay as h,X as b,am as y,H as w,r as x,o as k,g as _,h as M,e as R,v as V,b as F,u as T,ab as j,f as C,c as D,J as H,L as O,N as Y,a9 as E,a5 as S,a6 as $,R as A,U as I,a1 as P,_ as U}from"./index-OtYEJMgP.js";import{c as q,d as L}from"./ElectronicFence-d-yifEca.js";import{E as W}from"./icon_no_data-JkxAPqfn.js";import{d as Z}from"./constants-uiyZ18jc.js";const z={class:"w-full h-[640px] flex flex-row items-start justify-between gap-x-4"},G={class:"flex flex-col gap-y-4"},N={class:"flex flex-row items-center gap-x-2"},B={class:"w-2/3 h-full table-container flex flex-col gap-y-4 relative"},J={class:"flex flex-row items-center"},X={class:"flex-1 flex"},K=(e=>(A("data-v-6233944f"),e=e(),I(),e))((()=>R("div",{class:"flex-1 flex flex-row"},[R("div",{id:"map",class:"w-full h-full"})],-1))),Q={key:0,class:"w-full h-full flex flex-row items-center justify-center absolute left-0 top-0",style:{background:"rgb(0 0 0 / 50%)"}},ee=u((ae=((e,a)=>{for(var l in a||(a={}))n.call(a,l)&&s(e,l,a[l]);if(t)for(var l of t(a))r.call(a,l)&&s(e,l,a[l]);return e})({},{name:"FenceEditDialog"}),a(ae,l({__name:"FenceEditDialog",emits:["register","confirm"],setup(e,{emit:a}){const l=i(),t=i(),{height:n}=c(l),{height:r}=c(t),s=d((()=>({height:n.value-r.value+"px"}))),u=m(!1),A=m(null),I={name:[{required:!0,message:"请填写围栏名称！",trigger:"blur"},{max:16,message:"围栏名称长度不超过16位！",trigger:"blur"}],fenceMode:[{required:!0,message:"请选择模式！",trigger:"change"}],shapeType:[{required:!0,message:"请选择形状！",trigger:"change"}],enabledFlag:[{required:!0,message:"请选择是否启用！",trigger:"change"}],time:[{required:!0,message:"请选择报警时间！",trigger:"change"}]},U=f({keyWord:""}),ee=(e,a)=>o(this,null,(function*(){let l=[];we.value?yield we.value.search({keywords:e,complete:function(e,t){l=t.tips,l=t.tips.length>0?t.tips:[{name:"暂无数据",noId:!0}],a(l)}}):a(l)})),ae=(e,a)=>{""!==e&&ee(e,(l=>{let t="";t=e&&!l[0].noId?l.filter(le(e)):l,a(t)}))},le=e=>a=>0===a.name.toLowerCase().indexOf(e.toLowerCase()),te=f({location:""}),ne=e=>{Object.assign(te,e)},re=()=>{const{location:e=""}=te;e&&he.value.setCenter(e.split(","))&&he.value.setZoom(16)},se=f({id:"",name:"",fenceMode:"",shapeType:"",fenceRemark:"",enabledFlag:"",fenceSchedules:[],time:Z.range.default,timeRange:[]}),oe=()=>{const e=g(),a=[h().format("HH:mm:ss"),h().add(1,"h").format("HH:mm:ss")];se.timeRange.push({id:e,range:a})},{commonMap:ue}=p(),ie=i([]),ce=i(null),de=i(null),me=()=>{ce.value&&ce.value.clearData()},fe=()=>{de.value&&de.value.clearData()},pe=()=>{"1"===se.shapeType?ce.value?ie.value.length?$.error("请先清空围栏！"):ce.value.startDraw():$.error("请先初始化实例！"):"2"===se.shapeType&&(de.value?ie.value.length?$.error("请先清空围栏！"):de.value.startDraw():$.error("请先初始化实例！"))},ve=()=>{"1"===se.shapeType?me():"2"===se.shapeType&&fe(),ie.value=[]},ge=e=>{if(!e||!e.length)return null;const a=e[0];let l=0,t=0,n=Infinity,r=Infinity,s=-Infinity,o=-Infinity;a.forEach((e=>{const[a,u]=e;l+=a,t+=u,n=Math.min(n,a),r=Math.min(r,u),s=Math.max(s,a),o=Math.max(o,u)}));const u=a.length;return{center:[l/u,t/u],bounds:{ne:[s,o],sw:[n,r]}}},he=i(null),be=m([119.12477321074,33.074785125453]),ye=m(!1),we=m(null),xe=S((()=>o(this,null,(function*(){ye.value=!1,yield ke(),he.value=new ue.Map({container:"map",style:"aegis://styles/aegis/Satellite512",center:be.value,zoom:6.5,maxZoom:19.5,localIdeographFontFamily:"Microsoft YoHei"}),he.value.on("load",(()=>{ye.value=!0,new ue.RoadNetLayer({map:he.value,style:"aegis://styles/aegis/Road-v2"}).render(),we.value=new ue.AutoCompletePlusTask({map:he.value})}))}))),1e3),ke=()=>{console.log("destroyMap"),ce.value&&(ce.value.remove(),ce.value=null,ie.value=[]),de.value&&(de.value.remove(),de.value=null,ie.value=[]),he.value&&(he.value.remove(),he.value=null),ye.value=!1},_e=()=>o(this,null,(function*(){A.value&&(yield A.value.validate((e=>{e?se.timeRange.length?ie.value.length?"add"===Fe?Me():"edit"===Fe&&Re():$.error("请先绘制围栏！"):$.error("请先添加报警时间！"):$.error("请填写表单！")})))})),Me=S((()=>o(this,null,(function*(){u.value=!0;const{fenceMode:e,shapeType:a,name:l,fenceRemark:t,enabledFlag:n,time:r,timeRange:s}=se,[o,i]=r,c=s.map((e=>{const[a,l]=e.range;return{beginAt:`${o} ${a}`,endAt:`${i} ${l}`}})),d={area:ie.value[0].geometry,fenceMode:e,shapeType:a,name:l,fenceRemark:t,enabledFlag:n,fenceSchedules:c};yield q(d).then((e=>{P!==e&&($.success("添加成功"),Te("confirm"),He())})).finally((()=>{u.value=!1}))}))),1e3),Re=S((()=>o(this,null,(function*(){u.value=!0;const{id:e,fenceMode:a,shapeType:l,name:t,fenceRemark:n,enabledFlag:r,time:s,timeRange:o}=se,[i,c]=s,d=o.map((a=>{const[l,t]=a.range;return{fenceId:e,beginAt:`${i} ${l}`,endAt:`${c} ${t}`}})),m={id:e,area:ie.value[0].geometry,fenceMode:a,shapeType:l,name:t,fenceRemark:n,enabledFlag:r,fenceSchedules:d};yield L(m).then((e=>{P!==e&&($.success("编辑成功"),Te("confirm"),He())})).finally((()=>{u.value=!1}))}))),1e3),Ve=m(!1);let Fe="";const Te=a,[je,{closeDialog:Ce}]=v((e=>{Ve.value=!1;const{type:a,data:l}=e;if(xe(),Fe=a,"edit"===a){if(Object.keys(l).forEach((e=>{se[e]=l[e]})),l.area){const{center:e}=ge(l.area.coordinates);ie.value=[{type:"Feature",geometry:l.area,properties:{id:g()}}],"1"==l.shapeType&&Object.assign(ie.value[0].properties,{centerPoint:e})}if(se.fenceSchedules.length){const{beginAt:e,endAt:a}=se.fenceSchedules[0];se.time=[h(e).format("YYYY-MM-DD"),h(a).format("YYYY-MM-DD")],se.timeRange=se.fenceSchedules.map((e=>{const a=h(e.beginAt).format("HH:mm:ss"),l=h(e.endAt).format("HH:mm:ss");return{id:g(),range:[a,l]}}))}}b((()=>{Ve.value=!0}))})),De=()=>{"1"===se.shapeType?fe():"2"===se.shapeType&&me(),ie.value=[]},He=function(){u.value=!1,Ve.value=!1,Ce(),Object.keys(se).forEach((e=>{["fenceSchedules","timeRange"].includes(e)?se[e]=[]:se[e]="time"===e?Z.range.default:""})),ke()};return y((()=>{ye.value&&Ve.value&&(ce.value||(ce.value=new window.SGMap.DrawCircleHandler({map:he.value,enableEdit:!0,featuresList:ie.value}),ce.value.on("edit.circle.end",(function(){ie.value=ce.value.getFeatures()})),ce.value.on("draw.circle.end",(function(){ie.value=ce.value.getFeatures()}))),de.value||(de.value=new window.SGMap.DrawPolygonHandler({map:he.value,enableEdit:!0,featuresList:ie.value}),de.value.on("edit.polygon.end",(function(){ie.value=de.value.getFeatures()})),de.value.on("draw.polygon.end",(function(){ie.value=de.value.getFeatures()}))),b((()=>{(()=>{if(!ie.value.length)return;const{center:e,bounds:a}=ge(ie.value[0].geometry.coordinates);be.value=e,he.value.setCenter(e),he.value.fitBounds([a.sw,a.ne],{padding:{top:10,bottom:25,left:15,right:5}})})(),"1"===se.shapeType?fe():"2"===se.shapeType&&me()})))})),w((()=>{He()})),(e,a)=>{const n=x("el-input"),r=x("el-form-item"),o=x("el-option"),i=x("el-select"),c=x("el-radio"),d=x("el-radio-group"),m=x("el-date-picker"),f=x("el-button"),p=x("el-time-picker"),v=x("el-autocomplete"),g=x("el-empty");return k(),_(T(E),{width:"80%","show-close":!1,top:"32px",center:"","destroy-on-close":"","close-on-click-modal":!1,onClose:He,onRegister:T(je)},{default:M((()=>[R("div",z,[R("div",{ref_key:"containerRef",ref:l,class:"w-1/3 h-full table-container tree-container flex flex-col"},[R("div",{style:V(s.value),class:"overflow-auto"},[F(T(j),{ref_key:"refEditForm",ref:A,model:se,rules:I,"label-suffix":"：","label-width":"100px"},{default:M((()=>[F(r,{label:"名称",prop:"name"},{default:M((()=>[F(n,{modelValue:se.name,"onUpdate:modelValue":a[0]||(a[0]=e=>se.name=e),clearable:"",maxlength:"16","show-word-limit":"",disabled:u.value,placeholder:"请填写围栏名称",formatter:e=>e.replace(/^\s*|\s*$/g,""),parser:e=>e.replace(/^\s*|\s*$/g,"")},null,8,["modelValue","disabled","formatter","parser"])])),_:1}),F(r,{label:"模式",prop:"fenceMode"},{default:M((()=>[F(i,{modelValue:se.fenceMode,"onUpdate:modelValue":a[1]||(a[1]=e=>se.fenceMode=e),placeholder:"请选择围栏模式",clearable:""},{default:M((()=>[F(o,{value:"1",label:"禁止离开"}),F(o,{value:"2",label:"禁止进入"})])),_:1},8,["modelValue"])])),_:1}),F(r,{label:"形状",prop:"shapeType"},{default:M((()=>[F(i,{modelValue:se.shapeType,"onUpdate:modelValue":a[2]||(a[2]=e=>se.shapeType=e),placeholder:"请选择围栏形状",clearable:"",onChange:De},{default:M((()=>[F(o,{value:"1",label:"圆形"}),F(o,{value:"2",label:"多边形"})])),_:1},8,["modelValue"])])),_:1}),F(r,{label:"描述",prop:"fenceRemark"},{default:M((()=>[F(n,{modelValue:se.fenceRemark,"onUpdate:modelValue":a[3]||(a[3]=e=>se.fenceRemark=e),type:"textarea",clearable:"",placeholder:"请填写描述",maxlength:255,resize:"none",rows:5,"show-word-limit":"",disabled:u.value,parser:e=>e.replace(/^\s*|\s*$|\n/g,""),formatter:e=>e.replace(/^\s*|\s*$|\n/g,"")},null,8,["modelValue","disabled","parser","formatter"])])),_:1}),F(r,{label:"状态",prop:"enabledFlag"},{default:M((()=>[F(d,{modelValue:se.enabledFlag,"onUpdate:modelValue":a[4]||(a[4]=e=>se.enabledFlag=e),class:"ml-4",disabled:u.value},{default:M((()=>[F(c,{label:"1"},{default:M((()=>[C("启用")])),_:1}),F(c,{label:"0"},{default:M((()=>[C("禁用")])),_:1})])),_:1},8,["modelValue","disabled"])])),_:1}),F(r,{label:"报警时间",prop:"time"},{default:M((()=>[R("div",G,[R("div",N,[F(m,{modelValue:se.time,"onUpdate:modelValue":a[5]||(a[5]=e=>se.time=e),"value-format":"YYYY-MM-DD",type:"daterange","unlink-panels":"","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",clearable:!1,editable:!1,shortcuts:T(Z).range.shortcuts},null,8,["modelValue","shortcuts"]),F(f,{class:"basic-button",onClick:oe},{default:M((()=>[C(" 添加 ")])),_:1})]),(k(!0),D(H,null,O(se.timeRange,(e=>(k(),D("div",{key:e.id,class:"flex flex-row items-center gap-x-2"},[F(p,{modelValue:e.range,"onUpdate:modelValue":a=>e.range=a,"value-format":"HH:mm:ss","is-range":"","arrow-control":"","range-separator":"至","start-placeholder":"开始时间","end-placeholder":"结束时间",clearable:!1,editable:!1},null,8,["modelValue","onUpdate:modelValue"]),F(f,{class:"basic-button",onClick:a=>(e=>{const a=se.timeRange.filter((a=>a.id!==e.id));se.timeRange=a})(e)},{default:M((()=>[C(" 删除 ")])),_:2},1032,["onClick"])])))),128))])])),_:1})])),_:1},8,["model"])],4),R("div",{ref_key:"controlRef",ref:t,class:"flex flex-row items-center justify-center"},[F(f,{class:"basic-button",onClick:He},{default:M((()=>[C(" 取消 ")])),_:1}),F(f,{class:"basic-button",onClick:_e},{default:M((()=>[C(" 保存 ")])),_:1})],512)],512),R("div",B,[R("div",J,[R("div",X,[F(T(j),{inline:!0,"label-suffix":"：",class:"w-full table-query"},{default:M((()=>[F(r,{label:"地点",class:"m-0"},{default:M((()=>[F(v,{modelValue:U.keyWord,"onUpdate:modelValue":a[6]||(a[6]=e=>U.keyWord=e),"value-key":"name","fetch-suggestions":ae,debounce:1e3,clearable:"",placeholder:"请输入地点",onSelect:ne},null,8,["modelValue"])])),_:1}),F(r,{class:"m-0"},{default:M((()=>[F(f,{class:"basic-button",onClick:re},{default:M((()=>[C(" 定位 ")])),_:1})])),_:1})])),_:1})]),F(f,{class:"basic-button",onClick:ve},{default:M((()=>[C(" 清空围栏 ")])),_:1}),F(f,{class:"basic-button",onClick:pe},{default:M((()=>[C(" 绘制围栏 ")])),_:1})]),K,se.shapeType?Y("",!0):(k(),D("div",Q,[F(g,{description:"请先选择形状",image:T(W)},null,8,["image"])]))])])])),_:1},8,["onRegister"])}}}))));var ae;const le=U(ee,[["__scopeId","data-v-6233944f"]]);export{le as default};
