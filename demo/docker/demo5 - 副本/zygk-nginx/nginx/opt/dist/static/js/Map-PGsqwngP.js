var e=Object.defineProperty,a=Object.defineProperties,t=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,i=(a,t,o)=>t in a?e(a,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):a[t]=o,r=(e,a)=>{for(var t in a||(a={}))l.call(a,t)&&i(e,t,a[t]);if(o)for(var t of o(a))n.call(a,t)&&i(e,t,a[t]);return e},s=(e,a,t)=>new Promise(((o,l)=>{var n=e=>{try{r(t.next(e))}catch(a){l(a)}},i=e=>{try{r(t.throw(e))}catch(a){l(a)}},r=e=>e.done?o(e.value):Promise.resolve(e.value).then(n,i);r((t=t.apply(e,a)).next())}));import{h as u}from"./JobOverview-wJdELtdM.js";import{f as c}from"./math-kWy3cIhx.js";import{d as v,a7 as m,Y as d,A as p,n as y,P as f,at as g,am as h,X as k,V as z,F as w,o as F,c as L,a5 as E,$ as b,a1 as x,aM as _,_ as C}from"./index-OtYEJMgP.js";import{e as j}from"./mitt-ei5ABelY.js";const M=""+new URL("../png/icon_map_person_sos-Yl8bHrqF.png",import.meta.url).href,N={id:"map",class:"w-full h-full"},P=C(v({__name:"Map",props:{filter:{default:()=>({majorType:"",workRiskLevel:""})}},setup(e){const o=e,{commonMap:l}=m(),n=d(null),i={center:[119.12477321074,33.074785125453],zoom:{province:6.5,city:8,county:10}},v=p(!1),C=d([]),P=E((()=>s(this,null,(function*(){v.value=!1,C.value=[];const{majorType:e,workRiskLevel:a}=o.filter;yield u({majorType:e,workRiskLevel:a}).then((e=>{x!==e&&(C.value=e)})).finally((()=>{v.value=!0}))}))),1e3),T=p(i.center),D=e=>{var a;T.value=e,null==(a=n.value)||a.panTo(e)},O=y((()=>"1"==f().getOrgInfoState.type?"province":"2"==f().getOrgInfoState.type?"city":"county")),S=p(O.value),Z={id:"",type:"symbol",source:{type:"geojson",data:{type:"FeatureCollection",features:[]}},layout:{"icon-image":"","icon-size":1,"icon-ignore-placement":!0,"text-ignore-placement":!1,"text-field":"","text-size":12,"text-anchor":"top","text-allow-overlap":!1,"icon-anchor":"bottom","text-offset":[0,0],"text-max-width":8,"text-font":["Microsoft YaHei Regular"]},paint:{"text-color":"#ff0000","text-halo-color":"#FFFFFF","text-halo-width":1.33333}},R=p([]),$=()=>{R.value.forEach((e=>{n.value.removeLayer(e)})),R.value=[]},I=p([]),B=()=>{I.value.forEach((e=>{n.value.removeLayer(e)})),I.value=[]},H=p([]),Y=()=>{H.value.forEach((e=>{n.value.removeLayer(e)})),H.value=[]},A=p(!1),G=E((()=>s(this,null,(function*(){A.value=!1,yield q(),console.log("initMap"),n.value=new l.Map({container:"map",style:"aegis://styles/aegis/Satellite512",center:T.value,zoom:"province"==S.value?i.zoom.province:"city"==S.value?i.zoom.city-.5:i.zoom.county,maxZoom:19.5,localIdeographFontFamily:"Microsoft YoHei"}),n.value.on("load",(()=>{A.value=!0,n.value.loadImage(M,(function(e,a){n.value.addImage("sos_marker",a)})),n.value.on("zoom",J),j.on("onMapBack",(()=>{n.value.getZoom()>=i.zoom.county?n.value.setZoom(i.zoom.city+.1):n.value.getZoom()>i.zoom.province&&n.value.flyTo({center:i.center,zoom:i.zoom.province}),$(),B(),Y()})),j.on("onAlarmMarker",(e=>s(this,null,(function*(){if(yield $(),e.latitude&&e.longitude){n.value.flyTo({center:[e.longitude,e.latitude],zoom:i.zoom.county});const a=Z;a.layout["icon-image"]="sos_marker",a.layout["text-field"]=e.taskName,a.id=_(),a.source.data.features=[{type:"Feature",geometry:{type:"Point",coordinates:[e.longitude,e.latitude]},properties:{taskName:e.taskName}}],n.value.addLayer(a),R.value.push(a.id)}})))),j.on("onTaskDeviceMarker",(e=>s(this,null,(function*(){if(yield B(),e.latitude&&e.longitude){n.value.flyTo({center:[e.longitude,e.latitude],zoom:i.zoom.county});const a=Z;a.layout["icon-image"]="sos_marker",a.layout["text-field"]=e.taskName,a.id=_(),a.source.data.features=[{type:"Feature",geometry:{type:"Point",coordinates:[e.longitude,e.latitude]},properties:{taskName:e.taskName}}],n.value.addLayer(a),I.value.push(a.id)}})))),j.on("onImportantPlanMarker",(e=>s(this,null,(function*(){if(yield Y(),e.lat&&e.lng){n.value.flyTo({center:[e.lng,e.lat],zoom:i.zoom.county});const a=Z;a.layout["icon-image"]="sos_marker",a.layout["text-field"]=e.taskName,a.id=_(),a.source.data.features=[{type:"Feature",geometry:{type:"Point",coordinates:[e.longitude,e.latitude]},properties:{taskName:e.taskName}}],n.value.addLayer(a),H.value.push(a.id)}}))))}))}))),1e3),q=()=>{console.log("destroyMap"),n.value&&(n.value.remove(),n.value=null)},J=()=>{"county"!=S.value&&n.value.getZoom()>i.zoom.city||"county"==S.value&&n.value.getZoom()>i.zoom.county?j.emit("mapBackBtnShow",!0):j.emit("mapBackBtnShow",!1),n.value.getZoom()>i.zoom.city?V.value.forEach((e=>{e.getElement().classList.add("hide-class")})):V.value.forEach((e=>{e.getElement().classList.remove("hide-class")})),(n.value.getZoom()>i.zoom.county||n.value.getZoom()<=i.zoom.city)&&K.value.forEach((e=>{e.getElement().classList.add("hide-class")}))},U=d([]),V=d([]),X=d([]),K=d([]),Q=d([]),W=d([]),ee=()=>{console.log("initCityPaint"),U.value=[];const e=[],a=[];C.value.forEach((t=>{const o=Q.value.find((e=>e.name===t.name));o&&(o.center=b(o.center)?o.center:o.center.split(","),a.push({type:"Feature",geometry:o.shape}),e.push(r(r({},o),t)))})),U.value=e,n.value.getSource("city-polygon").setData({type:"FeatureCollection",features:a}),n.value.getSource("city-line").setData({type:"FeatureCollection",features:a})},ae=()=>{console.log("initCountyPaint"),X.value=[];const e=[],o=[];C.value.forEach((l=>{l.children&&l.children.forEach((n=>{W.value.forEach((i=>{var s;const u=i.find((e=>e.name===n.name));var c,v;u&&((null==u?void 0:u.center)instanceof Array||(u.center=null==(s=null==u?void 0:u.center)?void 0:s.split(",")),o.push({type:"Feature",geometry:u.shape}),e.push((c=r(r({},u),n),v={parentName:l.name},a(c,t(v)))))}))}))})),X.value=e,n.value.getSource("county-polygon").setData({type:"FeatureCollection",features:o}),n.value.getSource("county-line").setData({type:"FeatureCollection",features:o})},te=e=>e.length>=8?e.substring(0,7)+"...":e,oe=()=>{const e=[];U.value.forEach((a=>{const t=document.createElement("div");t.innerHTML=`\n      <div class='area-info-marker map_tag'>\n        <div class='area'>\n          <span title=${a.name}>${te(a.name)}</span>\n        </div>\n        <div class='row'>\n          <div>当前作业</div>\n          <span>${a.taskCount||0}</span>\n        </div>\n        <div class='cut-line'></div>\n        <div class='row'>\n          <div>在线终端</div>\n          <span>${a.deviceCount||0}</span>\n        </div>\n      </div>\n  `;const o=new l.Marker(t,{anchor:"bottom",offset:[0,0]});o.name=a.name,o.setLngLat([a.lng,a.lat]).addTo(n.value),o.getElement().onclick=()=>{const e=[];X.value.forEach((t=>{t.parentName==a.name&&e.push({type:"Feature",geometry:t.shape})})),n.value.getSource("county-polygon").setData({type:"FeatureCollection",features:e}),n.value.getSource("county-line").setData({type:"FeatureCollection",features:e}),K.value.forEach((e=>{e.parentName==a.name?e.getElement().classList.remove("hide-class"):e.getElement().classList.add("hide-class")})),n.value.setZoom(i.zoom.city+.1),T.value=[a.lng,a.lat],D(T.value)},e.push(o)})),V.value=e},le=()=>{const e=[];X.value.forEach((a=>{if("county"==S.value||"county"!=S.value&&(a.deviceCount||a.taskCount)){const t=document.createElement("div");t.innerHTML=`\n      <div class='area-info-marker map_tag'>\n        <div class='area'>\n          <span title=${a.name}>${te(a.name)}</span>\n        </div>\n        <div class='row'>\n          <div>当前作业</div>\n          <span>${a.taskCount}</span>\n        </div>\n        <div class='cut-line'></div>\n        <div class='row'>\n          <div>在线终端</div>\n          <span>${a.deviceCount}</span>\n        </div>\n      </div>\n  `;const o=new l.Marker(t,{anchor:"bottom",offset:[0,0]});o.name=a.name,o.parentName=a.parentName,"province"!=S.value&&"city"!=S.value||o.getElement().classList.add("hide-class"),o.setLngLat([a.lng,a.lat]).addTo(n.value),e.push(o),o.getElement().onclick=()=>{n.value.setZoom(i.zoom.county+.1),T.value=[a.lng,a.lat],D(T.value)}}})),K.value=e};return g((()=>o.filter),(()=>{P()}),{deep:!0,immediate:!0}),h((()=>{m().isMapReady&&G()})),h((()=>{A.value&&v.value&&(console.log("render map"),new l.RoadNetLayer({map:n.value,style:"aegis://styles/aegis/Road-v2"}).render(),n.value.addLayer({id:"city-polygon",type:"fill",source:{type:"geojson",data:{type:"FeatureCollection",features:[]}},paint:{"fill-color":"RGB(0, 232, 255)","fill-opacity":.3},maxzoom:i.zoom.city}),n.value.addLayer({id:"city-line",type:"line",source:{type:"geojson",data:{type:"FeatureCollection",features:[]}},paint:{"line-color":"#99ffff","line-width":2},maxzoom:i.zoom.city}),n.value.addLayer({id:"county-polygon",type:"fill",source:{type:"geojson",data:{type:"FeatureCollection",features:[]}},paint:{"fill-color":"RGB(0, 232, 255)","fill-opacity":.3},minzoom:i.zoom.city+.001}),n.value.addLayer({id:"county-line",type:"line",source:{type:"geojson",data:{type:"FeatureCollection",features:[]}},paint:{"line-color":"#99ffff","line-width":2},minzoom:i.zoom.city+.001}),(()=>{if("province"==S.value)T.value=i.center,Q.value=m().regionData[0].sub_districts,W.value=m().regionData[0].sub_districts.map((e=>e.sub_districts));else if("city"==S.value){const e=c(m().regionData,(e=>e.name===C.value[0].name),"sub_districts");T.value=b(e[0].center)?e[0].center:e[0].center.split(","),Q.value=e,W.value=[e[0].sub_districts]}else if("county"==S.value){const e=c(m().regionData,(e=>e.name===C.value[0].children[0].name),"sub_districts");T.value=b(e[0].center)?e[0].center:e[0].center.split(","),W.value=[e.map((e=>e))]}ae(),le(),"county"==S.value?D(T.value):(ee(),oe())})(),k((()=>{D(T.value)})))})),z((()=>{P()})),w((()=>{})),(e,a)=>(F(),L("div",N))}}),[["__scopeId","data-v-0e3af183"]]);export{P as default};
