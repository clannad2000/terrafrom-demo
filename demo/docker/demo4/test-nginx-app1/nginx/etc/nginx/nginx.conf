user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
}

http {
		include       /etc/nginx/mime.types;
		default_type  application/octet-stream;
		client_max_body_size 1000M;

		log_format debug '$remote_addr - $remote_user [$time_local] "$request" '
						 '$status $body_bytes_sent "$http_referer" '
						 '"$http_user_agent" "$http_x_forwarded_for" '
						 '$upstream_addr $upstream_status $request_time';

		access_log /var/log/nginx/access.log debug;

		sendfile        on;
		keepalive_timeout  65;

	# https
    server {
        listen 18080;
        server_name localhost;
        #ssl_certificate_key  /etc/nginx/zygk/cert/rsa_private.key;
        #ssl_certificate  /etc/nginx/zygk/cert/cert.crt;
		
		# 定义一个变量保存后端服务地址
        set $js_zygk_admin "js-zygk-admin:19510";
        set $js_zygk_app_api "js-zygk-app-api:19520";
		set $js_zygk_uaa "js-zygk-uaa:19530";
		
		# 处理其他静态文件
		location / {
			root   /opt/dist;
			index  index.html index.htm;
		}
		location /apkUpdate {
        	alias /opt/apkUpdate;
        }
		
		# 冀北作业管控项目后端
		location ^~ /js-zygk-admin/ {
			proxy_redirect off;
			proxy_set_header        Host $http_host;
			#proxy_set_header        Host $proxy_host;
			proxy_set_header        X-Real-IP $remote_addr;
			proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_pass http://$js_zygk_admin;
			proxy_set_header   Cookie $http_cookie;
			proxy_http_version 1.1;
			# 允许所有域名访问，也可以将 * 替换为特定的域名
			add_header Access-Control-Allow-Origin *;
			# 允许的请求方法
			add_header Access-Control-Allow-Methods *;
			# 允许的请求头
			add_header Access-Control-Allow-Headers *;
			# 预检请求有效期，单位：秒
			add_header Access-Control-Max-Age 1728000;
			# 当请求方法为 OPTIONS 时，立即返回响应
			if ($request_method = 'OPTIONS') {
					return 204;
			}
		}

		# 冀北作业管控项目_app
		location ^~ /js-zygk-app-api/ {
			proxy_redirect off;
			proxy_set_header        Host $http_host;
			#proxy_set_header        Host $proxy_host;
			proxy_set_header        X-Real-IP $remote_addr;
			proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_pass http://$js_zygk_app_api;
			proxy_set_header   Cookie $http_cookie;
			proxy_http_version 1.1;
			# 允许所有域名访问，也可以将 * 替换为特定的域名
			add_header Access-Control-Allow-Origin *;
			# 允许的请求方法
			add_header Access-Control-Allow-Methods *;
			# 允许的请求头
			add_header Access-Control-Allow-Headers *;
			# 预检请求有效期，单位：秒
			add_header Access-Control-Max-Age 1728000;
			# 当请求方法为 OPTIONS 时，立即返回响应
			if ($request_method = 'OPTIONS') {
					return 204;
			}
		}
		# 冀北作业动态管控项目ws
		location ^~ /js-zygk-app-api/ws {
			# 允许所有域名访问，也可以将 * 替换为特定的域名
			add_header Access-Control-Allow-Origin *;

			# 允许的请求方法
			add_header Access-Control-Allow-Methods *;

			# 允许的请求头
			add_header Access-Control-Allow-Headers *;

			# 预检请求有效期，单位：秒
			add_header Access-Control-Max-Age 1728000;

			# 当请求方法为 OPTIONS 时，立即返回响应
			if ($request_method = 'OPTIONS') {
					return 204;
			}
			proxy_pass http://$js_zygk_app_api;
			proxy_set_header X-Forwarded-For         $proxy_add_x_forwarded_for;
			client_max_body_size 300m;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "Upgrade";
			proxy_send_timeout 1800s;
			proxy_read_timeout 1800s;
			proxy_connect_timeout 1800s;
		}


		# 冀北作业管控项目_uaa
		location ^~ /js-zygk-uaa/ {
			proxy_redirect off;
			proxy_set_header        Host $http_host;
			#proxy_set_header        Host $proxy_host;
			proxy_set_header        X-Real-IP $remote_addr;
			proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_pass http://$js_zygk_uaa;
			proxy_set_header   Cookie $http_cookie;
			proxy_http_version 1.1;
			# 允许所有域名访问，也可以将 * 替换为特定的域名
			add_header Access-Control-Allow-Origin *;
			# 允许的请求方法
			add_header Access-Control-Allow-Methods *;
			# 允许的请求头
			add_header Access-Control-Allow-Headers *;
			# 预检请求有效期，单位：秒
			add_header Access-Control-Max-Age 1728000;
			# 当请求方法为 OPTIONS 时，立即返回响应
			if ($request_method = 'OPTIONS') {
					return 204;
			}
		}
		
		#/videoComponent --组件
		location ^~ /videoComponent/ {
			proxy_pass http://25.42.183.197:80;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}
		
		location ^~ /talk {
			proxy_pass http://25.42.183.197:21102; 
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "upgrade";
		}
		
		location ^~ /uvp-micro-service/mediatranscode/api/v1/play {
			proxy_pass http://25.42.183.197:21102;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}
		
		# 统一视频服务
		#/uvp-micro-service   --通信前缀
		#/uvpMircoServer      --通信前缀2
		#/uvp-backend-common     --通用服务
		#/uvp-backend-datafusion     --测点前缀
		location ~ ^/(uvp-micro-service|uvpMircoServer|uvp-backend-common|uvp-backend-datafusion) {
			proxy_pass http://25.42.183.197:80; 
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "upgrade";
		}
	}
}	

