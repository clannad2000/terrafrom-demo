var e=Object.defineProperty,a=Object.defineProperties,l=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,t=Object.prototype.propertyIsEnumerable,r=(a,l,i)=>l in a?e(a,l,{enumerable:!0,configurable:!0,writable:!0,value:i}):a[l]=i;import{u as o}from"./DeviceManage-aryRM0Sb.js";import{d as n,A as u,at as d,$ as p,aG as c,r as m,o as f,g as v,h as g,e as y,c as b,I as h,N as _,b as w,u as k,aH as x,t as I,aI as T,a6 as L,aJ as O,_ as j,a8 as q,a0 as z,F as V,f as C,ab as U,J as $,L as P,a2 as E,a9 as D,a1 as F}from"./index-OtYEJMgP.js";import{f as R}from"./constants-uiyZ18jc.js";const B={class:"el-upload__tip"},M={key:0},N={key:1},A={key:2},J=j(n({__name:"index",props:{fileItems:{type:Array,default:()=>[]},quantityLimit:{type:Number,default:1},fileTypes:{type:String,default:".png,.jpg,.jpeg"},sizeLimit:{type:Number,default:5},disabled:{type:Boolean,default:!1}},emits:["onImageChange"],setup(e,{expose:a,emit:l}){const i=l,s=e,t=u([]),r=u([]),o=u([]),n=(e,a)=>{const{raw:l}=e;console.log("rawFile",l);const t=T(R(s.fileTypes.split(",")));s.fileTypes&&!t.includes(l.type)?(L.error(`上传文件格式只能为${s.fileTypes}！`),a.splice(a.indexOf(e),1)):s.sizeLimit&&l.size/1024/1024>s.sizeLimit?(L.error(`上传文件大小不超过${s.sizeLimit}MB！`),a.splice(a.indexOf(e),1)):r.value.push(l),i("onImageChange",{files:O(k(r.value)),deleteIds:O(k(o.value))})},j=()=>{L.error(`最多只能选择${s.quantityLimit}个文件！`)},q=e=>{if(a=e,l="id",Reflect.has(a,l)){if(o.value.includes(e.id))return;o.value.push(e.id)}else(function(e,a){return Reflect.has(e,a)})(e,"uid")&&r.value.splice(r.value.indexOf(e),1);var a,l;t.value.splice(t.value.indexOf(e),1),i("onImageChange",{files:O(k(r.value)),deleteIds:O(k(o.value))})};return d((()=>s.fileItems),(e=>{p(s.fileItems)&&s.fileItems.length&&(t.value=e.map((e=>({id:e.id,name:e.name,url:c(e.id)}))))}),{immediate:!0}),a({clearUpload:()=>{t.value=[],r.value=[],o.value=[],i("onImageChange",{files:[],deleteIds:[]})}}),(e,a)=>{const l=m("el-icon"),i=m("el-upload");return f(),v(i,{"file-list":t.value,"onUpdate:fileList":a[0]||(a[0]=e=>t.value=e),class:I(["w-full",{"exceed-limit":t.value.length>=s.quantityLimit}]),limit:s.quantityLimit,accept:s.fileTypes,multiple:"",drag:"","auto-upload":!1,"on-remove":q,"on-change":n,"on-exceed":j,disabled:s.disabled},{tip:g((()=>[y("div",B,[s.quantityLimit?(f(),b("span",M," 文件数量："+h(s.quantityLimit)+"个；",1)):_("",!0),s.fileTypes?(f(),b("span",N," 格式："+h(s.fileTypes)+"；",1)):_("",!0),s.sizeLimit?(f(),b("span",A,"单文件大小："+h(s.sizeLimit)+"MB；",1)):_("",!0)])])),default:g((()=>[w(l,null,{default:g((()=>[w(k(x))])),_:1})])),_:1},8,["file-list","class","limit","accept","disabled"])}}}),[["__scopeId","data-v-e7dbae76"]]),S={class:"dialog-footer"},G=n((H=((e,a)=>{for(var l in a||(a={}))s.call(a,l)&&r(e,l,a[l]);if(i)for(var l of i(a))t.call(a,l)&&r(e,l,a[l]);return e})({},{name:"FirmwareUpgradeEditDialog"}),a(H,l({__name:"EditDialog",emits:["register","confirm"],setup(e,{emit:a}){const l=a,[i,{closeDialog:s}]=q((e=>{const{type:a}=e;c.value=a})),t=u(null),r=u(!1),n=u(""),d=u(),p={version:[{required:!0,message:"请填写程序版本！",trigger:"blur"}],deviceType:[{required:!0,message:"请选择设备类型！",trigger:"change"}],remark:[{required:!0,message:"请填写升级说明！",trigger:"blur"},{max:255,message:"升级说明长度不能超过255位！",trigger:"blur"}],files:[{required:!0,message:"请选择文件！",trigger:"change",validator(e,a,l){h.files.length?l():l(new Error("请选择文件！"))}}]},c=u(""),h=z({version:"",deviceType:"",remark:"",files:[]}),_=e=>{h.files=e.files||[]},x=function(){var e,a;r.value=!1,s(),Object.assign(h,{version:"",deviceType:"",remark:"",files:[]}),c.value="",n.value="",null==(e=t.value)||e.clearValidate(),null==(a=d.value)||a.clearUpload()},I=function(){var e;null==(e=t.value)||e.validate((e=>{return a=this,i=null,s=function*(){if(e){r.value=!0;const{deviceType:e,version:a,remark:i,files:s}=h;o({version:a,deviceType:e,remark:i,file:s[0]}).then((e=>{F!==e&&(L.success("上传成功！"),x(),l("confirm"))})).finally((()=>{r.value=!1}))}},new Promise(((e,l)=>{var t=e=>{try{o(s.next(e))}catch(a){l(a)}},r=e=>{try{o(s.throw(e))}catch(a){l(a)}},o=a=>a.done?e(a.value):Promise.resolve(a.value).then(t,r);o((s=s.apply(a,i)).next())}));var a,i,s}))};return V((()=>{})),(e,a)=>{const l=m("el-option"),s=m("el-select"),o=m("el-form-item"),n=m("el-input"),u=m("el-button");return f(),v(k(D),{width:"720","show-fullscreen":!1,"show-close":!1,"destroy-on-close":"",center:"",onClose:x,onRegister:k(i)},{footer:g((()=>[y("span",S,[w(u,{class:"basic-button",disabled:r.value,onClick:x},{default:g((()=>[C(" 返回 ")])),_:1},8,["disabled"]),w(u,{class:"basic-button",loading:r.value,onClick:I},{default:g((()=>[C(" 保存 ")])),_:1},8,["loading"])])])),default:g((()=>[w(k(U),{ref_key:"refFileEditForm",ref:t,rules:p,model:h,"label-width":"88px"},{default:g((()=>[w(o,{label:"设备类型",prop:"deviceType"},{default:g((()=>[w(s,{modelValue:h.deviceType,"onUpdate:modelValue":a[0]||(a[0]=e=>h.deviceType=e),placeholder:"请选择设备类型",clearable:""},{default:g((()=>[(f(!0),b($,null,P(k(E)().deviceTypeList,(e=>(f(),v(l,{key:e.code,value:e.code,label:e.name},null,8,["value","label"])))),128))])),_:1},8,["modelValue"])])),_:1}),w(o,{label:"程序版本",prop:"version"},{default:g((()=>[w(n,{modelValue:h.version,"onUpdate:modelValue":a[1]||(a[1]=e=>h.version=e),maxlength:"20",clearable:"",placeholder:"请填写程序版本，如：1.0.0.b.1","show-word-limit":"",disabled:"edit"==c.value,parser:e=>e.replace(/^\s*|\s*$|\n/g,""),formatter:e=>e.replace(/^\s*|\s*$|\n/g,"")},null,8,["modelValue","disabled","parser","formatter"])])),_:1}),w(o,{label:"升级说明",prop:"remark"},{default:g((()=>[w(n,{modelValue:h.remark,"onUpdate:modelValue":a[2]||(a[2]=e=>h.remark=e),type:"textarea",clearable:"",placeholder:"请填写升级说明",maxlength:255,resize:"none",rows:5,"show-word-limit":"",disabled:r.value,parser:e=>e.replace(/^\s*|\s*$|\n/g,""),formatter:e=>e.replace(/^\s*|\s*$|\n/g,"")},null,8,["modelValue","disabled","parser","formatter"])])),_:1}),w(o,{label:"文件",prop:"files"},{default:g((()=>[w(J,{ref_key:"fileUploaderRef",ref:d,"file-types":".zip,.apk","size-limit":1024,onOnImageChange:_},null,512)])),_:1})])),_:1},8,["model"])])),_:1},8,["onRegister"])}}}))));var H;export{G as _};
